/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 *
 * This file is a port of shadowCSS from webcomponents.js to TypeScript.
 * https://github.com/webcomponents/webcomponentsjs/blob/4efecd7e0e/src/ShadowCSS/ShadowCSS.js
 * https://github.com/angular/angular/blob/master/packages/compiler/src/shadow_css.ts
 */
const s=/(-shadowcsshost)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))?([^,{]*)/gim,o=/(-shadowcsscontext)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))?([^,{]*)/gim,t=/(-shadowcssslotted)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))?([^,{]*)/gim,n=/-shadowcsshost-no-combinator([^\s]*)/,e=[/::shadow/g,/::content/g],c=/-shadowcsshost/gim,r=/:host/gim,h=/::slotted/gim,a=/:host-context/gim,d=/\/\*\s*[\s\S]*?\*\//g,l=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g,i=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,g=/([{}])/g,u=(s,o)=>{const t=m(s);let n=0;return t.escapedString.replace(i,((...s)=>{const e=s[2];let c="",r=s[4],h="";r&&r.startsWith("{%BLOCK%")&&(c=t.blocks[n++],r=r.substring(8),h="{");const a=o({selector:e,content:c});return`${s[1]}${a.selector}${s[3]}${h}${a.content}${r}`}))},m=s=>{const o=s.split(g),t=[],n=[];let e=0,c=[];for(let r=0;r<o.length;r++){const s=o[r];"}"===s&&e--,e>0?c.push(s):(c.length>0&&(n.push(c.join("")),t.push("%BLOCK%"),c=[]),t.push(s)),"{"===s&&e++}return c.length>0&&(n.push(c.join("")),t.push("%BLOCK%")),{escapedString:t.join(""),blocks:n}},w=(s,o,t)=>s.replace(o,((...s)=>{if(s[2]){const o=s[2].split(","),n=[];for(let e=0;e<o.length;e++){const c=o[e].trim();if(!c)break;n.push(t("-shadowcsshost-no-combinator",c,s[3]))}return n.join(",")}return"-shadowcsshost-no-combinator"+s[3]})),p=(s,o,t)=>s+o.replace("-shadowcsshost","")+t,$=(s,o,t)=>o.indexOf("-shadowcsshost")>-1?p(s,o,t):s+o+t+", "+o+" "+s+t,_=(s,o,t)=>{const e="."+(o=o.replace(/\[is=([^\]]*)\]/g,((s,...o)=>o[0]))),r=s=>{let r=s.trim();if(!r)return"";if(s.indexOf("-shadowcsshost-no-combinator")>-1)r=((s,o,t)=>{if(c.lastIndex=0,c.test(s)){const o="."+t;return s.replace(n,((s,t)=>t.replace(/([^:]*)(:*)(.*)/,((s,t,n,e)=>t+o+n+e)))).replace(c,o+" ")}return o+" "+s})(s,o,t);else{const o=s.replace(c,"");if(o.length>0){const s=o.match(/([^:]*)(:*)(.*)/);s&&(r=s[1]+e+s[2]+s[3])}}return r},h=(s=>{const o=[];let t,n=0;return t=(s=s.replace(/(\[[^\]]*\])/g,((s,t)=>{const e=`__ph-${n}__`;return o.push(t),n++,e}))).replace(/(:nth-[-\w]+)(\([^)]+\))/g,((s,t,e)=>{const c=`__ph-${n}__`;return o.push(e),n++,t+c})),{content:t,placeholders:o}})(s);let a,d="",l=0;const i=/( |>|\+|~(?!=))\s*/g;let g=!((s=h.content).indexOf("-shadowcsshost-no-combinator")>-1);for(;null!==(a=i.exec(s));){const o=a[1],t=s.slice(l,a.index).trim();g=g||t.indexOf("-shadowcsshost-no-combinator")>-1,d+=`${g?r(t):t} ${o} `,l=i.lastIndex}const u=s.substring(l);return g=g||u.indexOf("-shadowcsshost-no-combinator")>-1,d+=g?r(u):u,m=h.placeholders,d.replace(/__ph-(\d+)__/g,((s,o)=>m[+o]));var m},f=(s,o,t,n)=>u(s,(s=>{let e=s.selector,c=s.content;return"@"!==s.selector[0]?e=((s,o,t,n)=>s.split(",").map((s=>n&&s.indexOf("."+n)>-1?s.trim():((s,o)=>!(s=>(s=s.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),RegExp("^("+s+")([>\\s~+[.,{:][\\s\\S]*)?$","m")))(o).test(s))(s,o)?_(s,o,t).trim():s.trim())).join(", "))(s.selector,o,t,n):(s.selector.startsWith("@media")||s.selector.startsWith("@supports")||s.selector.startsWith("@page")||s.selector.startsWith("@document"))&&(c=f(s.content,o,t,n)),{selector:e.replace(/\s{2,}/g," ").trim(),content:c}})),b=(n,c,d,l)=>{const i=((s,o)=>{const n="."+o+" > ",e=[];return s=s.replace(t,((...s)=>{if(s[2]){const o=s[2].trim(),t=n+o+s[3];let c="";for(let n=s[4]-1;n>=0;n--){const o=s[5][n];if("}"===o||","===o)break;c=o+c}const r=c+t,h=`${c.trimRight()}${t.trim()}`;return r.trim()!==h.trim()&&e.push({orgSelector:r,updatedSelector:`${h}, ${r}`}),t}return"-shadowcsshost-no-combinator"+s[3]})),{selectors:e,cssText:s}})(n=(s=>w(s,o,$))(n=(o=>w(o,s,p))(n=n.replace(a,"-shadowcsscontext").replace(r,"-shadowcsshost").replace(h,"-shadowcssslotted"))),l);return n=(s=>e.reduce(((s,o)=>s.replace(o," ")),s))(n=i.cssText),c&&(n=f(n,c,d,l)),{cssText:(n=(n=n.replace(/-shadowcsshost-no-combinator/g,"."+d)).replace(/>\s*\*\s+([^{, ]+)/gm," $1 ")).trim(),slottedSelectors:i.selectors}},x=(s,o,t)=>{const n=o+"-h",e=o+"-s",c=s.match(l)||[];s=(s=>s.replace(d,""))(s);const r=[];if(t){const o=s=>{const o=`/*!@___${r.length}___*/`;return r.push({placeholder:o,comment:`/*!@${s.selector}*/`}),s.selector=o+s.selector,s};s=u(s,(s=>"@"!==s.selector[0]?o(s):s.selector.startsWith("@media")||s.selector.startsWith("@supports")||s.selector.startsWith("@page")||s.selector.startsWith("@document")?(s.content=u(s.content,o),s):s))}const h=b(s,o,n,e);return s=[h.cssText,...c].join("\n"),t&&r.forEach((({placeholder:o,comment:t})=>{s=s.replace(o,t)})),h.slottedSelectors.forEach((o=>{s=s.replace(o.orgSelector,o.updatedSelector)})),s};export{x as scopeCss}